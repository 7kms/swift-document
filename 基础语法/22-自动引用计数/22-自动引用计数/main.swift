//
//  main.swift
//  22-è‡ªåŠ¨å¼•ç”¨è®¡æ•°
//
//  Created by tangl on 2019/12/4  11:36 AM
//  Copyright Â© 2019 km7. All rights reserved.
//
//  ---------------------------------------------------------
//  ğŸ˜ƒ  https://github.com/7kms
//  çƒ­çˆ±ç”Ÿæ´», å‹¤äºæ€è€ƒ, åŠªåŠ›å­¦ä¹ 
//  ---------------------------------------------------------
//

import Foundation

/**
 Swift ä½¿ç”¨è‡ªåŠ¨å¼•ç”¨è®¡æ•°ï¼ˆARCï¼‰æœºåˆ¶æ¥è·Ÿè¸ªå’Œç®¡ç†ä½ çš„åº”ç”¨ç¨‹åºçš„å†…å­˜ã€‚
 
 æ³¨: å¼•ç”¨è®¡æ•°ä»…ä»…åº”ç”¨äºç±»çš„å®ä¾‹ã€‚ç»“æ„ä½“å’Œæšä¸¾ç±»å‹æ˜¯å€¼ç±»å‹ï¼Œä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œä¹Ÿä¸æ˜¯é€šè¿‡å¼•ç”¨çš„æ–¹å¼å­˜å‚¨å’Œä¼ é€’ã€‚
 */

//1. è‡ªåŠ¨å¼•ç”¨è®¡æ•°çš„å·¥ä½œæœºåˆ¶
/**
 1). å½“åˆ›å»ºä¸€ä¸ªç±»çš„æ–°çš„å®ä¾‹çš„æ—¶å€™ï¼ŒARC ä¼šåˆ†é…ä¸€å—å†…å­˜æ¥å‚¨å­˜è¯¥å®ä¾‹ä¿¡æ¯ã€‚å†…å­˜ä¸­ä¼šåŒ…å«å®ä¾‹çš„ç±»å‹ä¿¡æ¯ï¼Œä»¥åŠè¿™ä¸ªå®ä¾‹æ‰€æœ‰ç›¸å…³çš„å­˜å‚¨å‹å±æ€§çš„å€¼ã€‚
 2). å½“å®ä¾‹ä¸å†è¢«ä½¿ç”¨æ—¶ï¼ŒARC é‡Šæ”¾å®ä¾‹æ‰€å ç”¨çš„å†…å­˜ï¼Œå¹¶è®©é‡Šæ”¾çš„å†…å­˜èƒ½æŒªä½œä»–ç”¨ã€‚è¿™ç¡®ä¿äº†ä¸å†è¢«ä½¿ç”¨çš„å®ä¾‹ï¼Œä¸ä¼šä¸€ç›´å ç”¨å†…å­˜ç©ºé—´ã€‚
 3). å½“ ARC æ”¶å›å’Œé‡Šæ”¾äº†æ­£åœ¨è¢«ä½¿ç”¨ä¸­çš„å®ä¾‹ï¼Œè¯¥å®ä¾‹çš„å±æ€§å’Œæ–¹æ³•å°†ä¸èƒ½å†è¢«è®¿é—®å’Œè°ƒç”¨. å¦‚æœä½ è¯•å›¾è®¿é—®è¿™ä¸ªå®ä¾‹ï¼Œåº”ç”¨ç¨‹åºå¾ˆå¯èƒ½ä¼šå´©æºƒã€‚
 4). ä¸ºäº†ç¡®ä¿ä½¿ç”¨ä¸­çš„å®ä¾‹ä¸ä¼šè¢«é”€æ¯ï¼ŒARC ä¼šè·Ÿè¸ªå’Œè®¡ç®—æ¯ä¸€ä¸ªå®ä¾‹æ­£åœ¨è¢«å¤šå°‘å±æ€§ï¼Œå¸¸é‡å’Œå˜é‡æ‰€å¼•ç”¨ã€‚å®ä¾‹çš„å¼•ç”¨æ•°ä¸ºå¤§äº0ï¼ŒARC éƒ½ä¸ä¼šé”€æ¯è¿™ä¸ªå®ä¾‹
 5). æ— è®ºä½ å°†å®ä¾‹èµ‹å€¼ç»™å±æ€§ã€å¸¸é‡æˆ–å˜é‡ï¼Œå®ƒä»¬éƒ½ä¼šåˆ›å»ºæ­¤å®ä¾‹çš„å¼ºå¼•ç”¨ã€‚ä¹‹æ‰€ä»¥ç§°ä¹‹ä¸ºâ€œå¼ºâ€å¼•ç”¨ï¼Œæ˜¯å› ä¸ºå®ƒä¼šå°†å®ä¾‹ç‰¢ç‰¢åœ°ä¿æŒä½ï¼Œåªè¦å¼ºå¼•ç”¨è¿˜åœ¨ï¼Œå®ä¾‹æ˜¯ä¸å…è®¸è¢«é”€æ¯çš„ã€‚
 */

//2. è‡ªåŠ¨å¼•ç”¨è®¡æ•°å®è·µ
/**
 ARC ä¼šè·Ÿè¸ªä½ æ‰€æ–°åˆ›å»ºçš„ Person å®ä¾‹çš„å¼•ç”¨æ•°é‡ï¼Œå¹¶ä¸”ä¼šåœ¨ Person å®ä¾‹ä¸å†è¢«éœ€è¦æ—¶é”€æ¯å®ƒ
 */
class Person {
    let name: String
    init(name: String) {
        self.name = name
        print("\(name) is being initialized")
    }
    deinit {
        //ææ„å‡½æ•°ä¼šåœ¨å®ä¾‹è¢«é”€æ¯æ—¶è°ƒç”¨
        print("\(name) is being deinitialized")
    }
}
var reference1: Person?
var reference2: Person?
var reference3: Person?
reference1 = Person(name: "John Appleseed") // Personå®ä¾‹è¢«èµ‹å€¼ç»™äº† reference1 å˜é‡ï¼Œæ‰€ä»¥ reference1 åˆ° Person ç±»çš„æ–°å®ä¾‹ä¹‹é—´å»ºç«‹äº†ä¸€ä¸ªå¼ºå¼•ç”¨
reference2 = reference1 // åŒä¸€ä¸ª Person å®ä¾‹èµ‹å€¼ç»™å…¶ä»–å˜é‡ï¼Œè¯¥å®ä¾‹å°±ä¼šå¤šå‡ºä¸€ä¸ªå¼ºå¼•ç”¨
reference3 = reference1
reference1 = nil
reference2 = nil
reference3 = nil // æ˜¯æœ€åä¸€ä¸ªå¼ºå¼•ç”¨è¢«æ–­å¼€æ—¶ï¼ŒARC ä¼šé”€æ¯å®ƒ
//3. ç±»å®ä¾‹ä¹‹é—´çš„å¾ªç¯å¼ºå¼•ç”¨
/**
 å¦‚æœä¸¤ä¸ªç±»å®ä¾‹äº’ç›¸æŒæœ‰å¯¹æ–¹çš„å¼ºå¼•ç”¨ï¼Œå› è€Œæ¯ä¸ªå®ä¾‹éƒ½è®©å¯¹æ–¹ä¸€ç›´å­˜åœ¨ï¼Œå°±æ˜¯è¿™ç§æƒ…å†µã€‚è¿™å°±æ˜¯æ‰€è°“çš„å¾ªç¯å¼ºå¼•ç”¨ã€‚
 
 å¯ä»¥é€šè¿‡å®šä¹‰ç±»ä¹‹é—´çš„å…³ç³»ä¸ºå¼±å¼•ç”¨æˆ–æ— ä¸»å¼•ç”¨ï¼Œä»¥æ›¿ä»£å¼ºå¼•ç”¨ï¼Œä»è€Œè§£å†³å¾ªç¯å¼ºå¼•ç”¨çš„é—®é¢˜
 */
print("-------------")
class Person2 {
    let name: String
    init(name: String) { self.name = name }
    var apartment: Apartment?
    deinit { print("\(name) is being deinitialized") }
}

class Apartment {
    let unit: String
    init(unit: String) { self.unit = unit }
    var tenant: Person2?
    deinit { print("Apartment \(unit) is being deinitialized") }
}

var john: Person2?
var unit4A: Apartment?

john = Person2(name: "John Appleseed")
unit4A = Apartment(unit: "4A")

// å°†ä¸¤ä¸ªå®ä¾‹å…³è”åˆ°ä¸€èµ·
john?.apartment = unit4A
unit4A?.tenant = john

// å½“ä½ æŠŠè¿™ä¸¤ä¸ªå˜é‡è®¾ä¸º nil æ—¶ï¼Œæ²¡æœ‰ä»»ä½•ä¸€ä¸ªææ„å‡½æ•°è¢«è°ƒç”¨ã€‚å¾ªç¯å¼ºå¼•ç”¨ä¼šä¸€ç›´é˜»æ­¢ Person å’Œ Apartment ç±»å®ä¾‹çš„é”€æ¯ï¼Œè¿™å°±åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­é€ æˆäº†å†…å­˜æ³„æ¼
john = nil
unit4A = nil
//4. è§£å†³å®ä¾‹ä¹‹é—´çš„å¾ªç¯å¼ºå¼•ç”¨
/**
 1). å¼±å¼•ç”¨ï¼ˆweak referenceï¼‰
 2). æ— ä¸»å¼•ç”¨ï¼ˆunowned referenceï¼‰
 å¼±å¼•ç”¨å’Œæ— ä¸»å¼•ç”¨å…è®¸å¾ªç¯å¼•ç”¨ä¸­çš„ä¸€ä¸ªå®ä¾‹å¼•ç”¨è€Œå¦å¤–ä¸€ä¸ªå®ä¾‹ä¸ä¿æŒå¼ºå¼•ç”¨
 */
//4.1 å¼±å¼•ç”¨
/**
 å¼±å¼•ç”¨ä¸ä¼šå¯¹å…¶å¼•ç”¨çš„å®ä¾‹ä¿æŒå¼ºå¼•ç”¨ï¼Œå› è€Œä¸ä¼šé˜»æ­¢ ARC é”€æ¯è¢«å¼•ç”¨çš„å®ä¾‹
 è¯­æ³•: å£°æ˜å±æ€§æˆ–è€…å˜é‡ï¼Œåœ¨å‰é¢åŠ ä¸Š weak å…³é”®å­—è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ã€‚
 1). å› ä¸ºå¼±å¼•ç”¨ä¸ä¼šä¿æŒæ‰€å¼•ç”¨çš„å®ä¾‹ï¼Œå³ä½¿å¼•ç”¨å­˜åœ¨ï¼Œå®ä¾‹ä¹Ÿæœ‰å¯èƒ½è¢«é”€æ¯
 2). ARC ä¼šåœ¨å¼•ç”¨çš„å®ä¾‹è¢«é”€æ¯åè‡ªåŠ¨å°†å…¶èµ‹å€¼ä¸º nil
 3). å¼±å¼•ç”¨åªèƒ½å®šä¹‰æˆå¯é€‰ç±»å‹å˜é‡(å› ä¸ºå¼±å¼•ç”¨å¯ä»¥å…è®¸å®ƒä»¬çš„å€¼åœ¨è¿è¡Œæ—¶è¢«èµ‹å€¼ä¸º nil)
 
 æ³¨: å½“ ARC è®¾ç½®å¼±å¼•ç”¨ä¸º nil æ—¶ï¼Œå±æ€§è§‚å¯Ÿä¸ä¼šè¢«è§¦å‘ã€‚
 */
var c = {
    class Person {
        let name: String
        init(name: String) { self.name = name }
        var apartment: Apartment?
        deinit { print("\(name) is being deinitialized") }
    }

    class Apartment {
        let unit: String
        init(unit: String) { self.unit = unit }
        weak var tenant: Person?
        deinit { print("Apartment \(unit) is being deinitialized") }
    }
    var john: Person?
    var unit4A: Apartment?

    john = Person(name: "John Appleseed")
    unit4A = Apartment(unit: "4A")

    john!.apartment = unit4A
    unit4A!.tenant = john
}
c()
/**
 æ³¨: åœ¨ä½¿ç”¨åƒåœ¾æ”¶é›†çš„ç³»ç»Ÿé‡Œï¼Œå¼±æŒ‡é’ˆæœ‰æ—¶ç”¨æ¥å®ç°ç®€å•çš„ç¼“å†²æœºåˆ¶ï¼Œå› ä¸ºæ²¡æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡åªä¼šåœ¨å†…å­˜å‹åŠ›è§¦å‘åƒåœ¾æ”¶é›†æ—¶æ‰è¢«é”€æ¯ã€‚ä½†æ˜¯åœ¨ ARC ä¸­ï¼Œä¸€æ—¦å€¼çš„æœ€åä¸€ä¸ªå¼ºå¼•ç”¨è¢«ç§»é™¤ï¼Œå°±ä¼šè¢«ç«‹å³é”€æ¯ï¼Œè¿™å¯¼è‡´å¼±å¼•ç”¨å¹¶ä¸é€‚åˆä¸Šé¢çš„ç”¨é€”ã€‚
 */
//4.2 æ— ä¸»å¼•ç”¨
/**
 å’Œå¼±å¼•ç”¨ç±»ä¼¼ï¼Œæ— ä¸»å¼•ç”¨ä¸ä¼šç‰¢ç‰¢ä¿æŒä½å¼•ç”¨çš„å®ä¾‹ã€‚å’Œå¼±å¼•ç”¨ä¸åŒçš„æ˜¯ï¼Œæ— ä¸»å¼•ç”¨åœ¨å…¶ä»–å®ä¾‹æœ‰ç›¸åŒæˆ–è€…æ›´é•¿çš„ç”Ÿå‘½å‘¨æœŸæ—¶ä½¿ç”¨
 è¯­æ³•: åœ¨å£°æ˜å±æ€§æˆ–è€…å˜é‡æ—¶ï¼Œåœ¨å‰é¢åŠ ä¸Šå…³é”®å­— unowned è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ— ä¸»å¼•ç”¨
 
 æ— ä¸»å¼•ç”¨é€šå¸¸éƒ½è¢«æœŸæœ›æ‹¥æœ‰å€¼ã€‚ä¸è¿‡ ARC æ— æ³•åœ¨å®ä¾‹è¢«é”€æ¯åå°†æ— ä¸»å¼•ç”¨è®¾ä¸º nilï¼Œå› ä¸ºéå¯é€‰ç±»å‹çš„å˜é‡ä¸å…è®¸è¢«èµ‹å€¼ä¸º nil
 
 æ³¨: ä½¿ç”¨æ— ä¸»å¼•ç”¨ï¼Œä½ å¿…é¡»ç¡®ä¿å¼•ç”¨å§‹ç»ˆæŒ‡å‘ä¸€ä¸ªæœªé”€æ¯çš„å®ä¾‹ã€‚å¦‚æœä½ è¯•å›¾åœ¨å®ä¾‹è¢«é”€æ¯åï¼Œè®¿é—®è¯¥å®ä¾‹çš„æ— ä¸»å¼•ç”¨ï¼Œä¼šè§¦å‘è¿è¡Œæ—¶é”™è¯¯ã€‚
 */
print("-------------")

let d = {
    class Customer {
        let name: String
        var card: CreditCard? // Customer å®ä¾‹æŒæœ‰å¯¹ CreditCard å®ä¾‹çš„å¼ºå¼•ç”¨
        init(name: String) {
            self.name = name
        }
        deinit { print("\(name) is being deinitialized") }
    }
    
    class CreditCard {
        let number: UInt64 //CreditCard ç±»çš„ number å±æ€§è¢«å®šä¹‰ä¸º UInt64 ç±»å‹è€Œä¸æ˜¯ Int ç±»å‹ï¼Œä»¥ç¡®ä¿ number å±æ€§çš„å­˜å‚¨é‡åœ¨ 32 ä½å’Œ 64 ä½ç³»ç»Ÿä¸Šéƒ½èƒ½è¶³å¤Ÿå®¹çº³ 16 ä½çš„å¡å·ã€‚
        unowned let customer: Customer //CreditCard å®ä¾‹æŒæœ‰å¯¹ Customer å®ä¾‹çš„æ— ä¸»å¼•ç”¨
        init(number: UInt64, customer: Customer) {
            self.number = number
            self.customer = customer
        }
        deinit { print("Card #\(number) is being deinitialized") }
    }
    
    var john: Customer?
    john = Customer(name: "John Appleseed")
    john!.card = CreditCard(number: 1234_5678_9012_3456, customer: john!)
    
    // æ–­å¼€ john å˜é‡æŒæœ‰çš„å¼ºå¼•ç”¨æ—¶ï¼Œå†ä¹Ÿæ²¡æœ‰æŒ‡å‘ Customer å®ä¾‹çš„å¼ºå¼•ç”¨äº†
    // ç”±äºå†ä¹Ÿæ²¡æœ‰æŒ‡å‘ Customer å®ä¾‹çš„å¼ºå¼•ç”¨ï¼Œè¯¥å®ä¾‹è¢«é”€æ¯äº†ã€‚å…¶åï¼Œå†ä¹Ÿæ²¡æœ‰æŒ‡å‘ CreditCard å®ä¾‹çš„å¼ºå¼•ç”¨ï¼Œè¯¥å®ä¾‹ä¹Ÿéšä¹‹è¢«é”€æ¯äº†ï¼š
    john = nil
    
    
    /**
     æ³¨:  ä¸Šé¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨å®‰å…¨çš„æ— ä¸»å¼•ç”¨ã€‚å¯¹äºéœ€è¦ç¦ç”¨è¿è¡Œæ—¶çš„å®‰å…¨æ£€æŸ¥çš„æƒ…å†µï¼ˆä¾‹å¦‚ï¼Œå‡ºäºæ€§èƒ½æ–¹é¢çš„åŸå› ï¼‰ï¼ŒSwift è¿˜æä¾›äº†ä¸å®‰å…¨çš„æ— ä¸»å¼•ç”¨ã€‚ä¸æ‰€æœ‰ä¸å®‰å…¨çš„æ“ä½œä¸€æ ·ï¼Œä½ éœ€è¦è´Ÿè´£æ£€æŸ¥ä»£ç ä»¥ç¡®ä¿å…¶å®‰å…¨æ€§ã€‚ ä½ å¯ä»¥é€šè¿‡ unowned(unsafe) æ¥å£°æ˜ä¸å®‰å…¨æ— ä¸»å¼•ç”¨ã€‚å¦‚æœä½ è¯•å›¾åœ¨å®ä¾‹è¢«é”€æ¯åï¼Œè®¿é—®è¯¥å®ä¾‹çš„ä¸å®‰å…¨æ— ä¸»å¼•ç”¨ï¼Œä½ çš„ç¨‹åºä¼šå°è¯•è®¿é—®è¯¥å®ä¾‹ä¹‹å‰æ‰€åœ¨çš„å†…å­˜åœ°å€ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸å®‰å…¨çš„æ“ä½œã€‚
     */
}
d()

//4.2.1 æ— ä¸»å¼•ç”¨å’Œéšå¼è§£æå¯é€‰å±æ€§
/**
 å¼±å¼•ç”¨åœºæ™¯:
 Person å’Œ Apartment çš„ä¾‹å­å±•ç¤ºäº†ä¸¤ä¸ªå±æ€§çš„å€¼éƒ½å…è®¸ä¸º nilï¼Œå¹¶ä¼šæ½œåœ¨çš„äº§ç”Ÿå¾ªç¯å¼ºå¼•ç”¨ã€‚è¿™ç§åœºæ™¯æœ€é€‚åˆç”¨å¼±å¼•ç”¨æ¥è§£å†³ã€‚

 æ— ä¸»å¼•ç”¨åœºæ™¯:
 Customer å’Œ CreditCard çš„ä¾‹å­å±•ç¤ºäº†ä¸€ä¸ªå±æ€§çš„å€¼å…è®¸ä¸º nilï¼Œè€Œå¦ä¸€ä¸ªå±æ€§çš„å€¼ä¸å…è®¸ä¸º nilï¼Œè¿™ä¹Ÿå¯èƒ½ä¼šäº§ç”Ÿå¾ªç¯å¼ºå¼•ç”¨ã€‚è¿™ç§åœºæ™¯æœ€é€‚åˆé€šè¿‡æ— ä¸»å¼•ç”¨æ¥è§£å†³ã€‚
 
 
 å­˜åœ¨ç€ç¬¬ä¸‰ç§åœºæ™¯ï¼Œåœ¨è¿™ç§åœºæ™¯ä¸­ï¼Œä¸¤ä¸ªå±æ€§éƒ½å¿…é¡»æœ‰å€¼ï¼Œå¹¶ä¸”åˆå§‹åŒ–å®Œæˆåæ°¸è¿œä¸ä¼šä¸º nilã€‚åœ¨è¿™ç§åœºæ™¯ä¸­ï¼Œéœ€è¦ä¸€ä¸ªç±»ä½¿ç”¨æ— ä¸»å±æ€§ï¼Œè€Œå¦å¤–ä¸€ä¸ªç±»ä½¿ç”¨éšå¼è§£æå¯é€‰å±æ€§ã€‚
 */
print("-------------")
let e = {
    class Country {
        let name: String
        var capitalCity: City! // capitalCity å±æ€§å£°æ˜ä¸ºéšå¼è§£æå¯é€‰ç±»å‹çš„å±æ€§, é»˜è®¤å€¼æ˜¯nil
        init(name: String, capitalName: String) {
            
            
            //ç”±äº capitalCity é»˜è®¤å€¼ä¸º nilï¼Œä¸€æ—¦ Country çš„å®ä¾‹åœ¨æ„é€ å‡½æ•°ä¸­ç»™ name å±æ€§èµ‹å€¼åï¼Œæ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹å°±å®Œæˆäº†
            self.name = name
            
            
            //ä¸€æ—¦ name å±æ€§è¢«èµ‹å€¼åï¼ŒCountry çš„æ„é€ å‡½æ•°å°±èƒ½å¼•ç”¨å¹¶ä¼ é€’éšå¼çš„ self
            //Country çš„æ„é€ å‡½æ•°åœ¨èµ‹å€¼ capitalCity æ—¶ï¼Œå°±èƒ½å°† self ä½œä¸ºå‚æ•°ä¼ é€’ç»™ City çš„æ„é€ å‡½æ•°ã€‚
            self.capitalCity = City(name: capitalName, country: self)
            
            //æ„ä¹‰åœ¨äºä½ å¯ä»¥é€šè¿‡ä¸€æ¡è¯­å¥åŒæ—¶åˆ›å»º Country å’Œ City çš„å®ä¾‹ï¼Œè€Œä¸äº§ç”Ÿå¾ªç¯å¼ºå¼•ç”¨ï¼Œå¹¶ä¸” capitalCity çš„å±æ€§èƒ½è¢«ç›´æ¥è®¿é—®ï¼Œè€Œä¸éœ€è¦é€šè¿‡æ„Ÿå¹å·æ¥å±•å¼€å®ƒçš„å¯é€‰å€¼
        }
        deinit {
            print("country destory")
        }
    }
    
    class City {
        let name: String
        unowned let country: Country
        init(name: String, country: Country) {
            self.name = name
            self.country = country
        }
        deinit {
            print("city destory")
        }
    }
    
    var country: Country! = Country(name: "Canada", capitalName: "Ottawa")
    print("\(country!.name)'s capital city is called \(country!.capitalCity.name)")
    country = nil
}
e()
//5. é—­åŒ…å¼•èµ·çš„å¾ªç¯å¼ºå¼•ç”¨
/**
 å½“ä½ å°†ä¸€ä¸ªé—­åŒ…èµ‹å€¼ç»™ç±»å®ä¾‹çš„æŸä¸ªå±æ€§ï¼Œå¹¶ä¸”è¿™ä¸ªé—­åŒ…ä½“ä¸­åˆä½¿ç”¨äº†è¿™ä¸ªç±»å®ä¾‹æ—¶.
 è¿™ä¸ªé—­åŒ…ä½“ä¸­å¯èƒ½è®¿é—®äº†å®ä¾‹çš„æŸä¸ªå±æ€§ï¼Œä¾‹å¦‚ self.somePropertyï¼Œæˆ–è€…é—­åŒ…ä¸­è°ƒç”¨äº†å®ä¾‹çš„æŸä¸ªæ–¹æ³•ï¼Œä¾‹å¦‚ self.someMethod()ã€‚è¿™ä¸¤ç§æƒ…å†µéƒ½å¯¼è‡´äº†é—­åŒ…â€œæ•è·â€selfï¼Œä»è€Œäº§ç”Ÿäº†å¾ªç¯å¼ºå¼•ç”¨ã€‚
 */
print("-------------")
let f = {
    class HTMLElement {
        let name: String
        let text: String?
        
        /**
         asHTML å£°æ˜ä¸º lazy å±æ€§ï¼Œå› ä¸ºåªæœ‰å½“å…ƒç´ ç¡®å®éœ€è¦è¢«å¤„ç†ä¸º HTML è¾“å‡ºçš„å­—ç¬¦ä¸²æ—¶ï¼Œæ‰éœ€è¦ä½¿ç”¨ asHTMLã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨é»˜è®¤çš„é—­åŒ…ä¸­å¯ä»¥ä½¿ç”¨ selfï¼Œå› ä¸ºåªæœ‰å½“åˆå§‹åŒ–å®Œæˆä»¥åŠ self ç¡®å®å­˜åœ¨åï¼Œæ‰èƒ½è®¿é—® lazy å±æ€§ã€‚
         */
        lazy var asHTML: () -> String = { // å®ä¾‹çš„ asHTML å±æ€§æŒæœ‰é—­åŒ…çš„å¼ºå¼•ç”¨
            
            // é—­åŒ…æ•è·äº† selfï¼Œè¿™æ„å‘³ç€é—­åŒ…åˆåè¿‡æ¥æŒæœ‰äº† HTMLElement å®ä¾‹çš„å¼ºå¼•ç”¨ã€‚è¿™æ ·ä¸¤ä¸ªå¯¹è±¡å°±äº§ç”Ÿäº†å¾ªç¯å¼ºå¼•ç”¨ã€‚
            // è™½ç„¶é—­åŒ…å¤šæ¬¡ä½¿ç”¨äº† selfï¼Œå®ƒåªæ•è· HTMLElement å®ä¾‹çš„ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚
            if let text = self.text {
                 return "<\(self.name)>\(text)</\(self.name)>"
            }else {
                return "<\(self.name) />"
            }
        }
        init(name: String, text: String? = nil) {
            self.name = name
            self.text = text
        }
        deinit {
            print("\(name) is being deinitialized")
        }
    }
    
    let heading = HTMLElement(name: "h1")
    let defaultText = "some default text"
    heading.asHTML = {
        return "<\(heading.name)>\(heading.text ?? defaultText)</\(heading.name)>"
    }
    print(heading.asHTML())
    
    
    //  paragraph å˜é‡å®šä¹‰ä¸ºå¯é€‰ç±»å‹çš„ HTMLElementï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥èµ‹å€¼ nil ç»™å®ƒæ¥æ¼”ç¤ºå¾ªç¯å¼ºå¼•ç”¨ã€‚
    var paragraph: HTMLElement? = HTMLElement(name: "p", text: "hello, world")
    print(paragraph!.asHTML())
    
    paragraph = nil //
}
f()

//6. è§£å†³é—­åŒ…å¼•èµ·çš„å¾ªç¯å¼ºå¼•ç”¨
/**
 åœ¨å®šä¹‰é—­åŒ…æ—¶åŒæ—¶å®šä¹‰æ•è·åˆ—è¡¨ä½œä¸ºé—­åŒ…çš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥è§£å†³é—­åŒ…å’Œç±»å®ä¾‹ä¹‹é—´çš„å¾ªç¯å¼ºå¼•ç”¨
 è·Ÿè§£å†³ä¸¤ä¸ªç±»å®ä¾‹é—´çš„å¾ªç¯å¼ºå¼•ç”¨ä¸€æ ·ï¼Œå£°æ˜æ¯ä¸ªæ•è·çš„å¼•ç”¨ä¸ºå¼±å¼•ç”¨æˆ–æ— ä¸»å¼•ç”¨ï¼Œè€Œä¸æ˜¯å¼ºå¼•ç”¨ã€‚
 
 
 æ³¨: Swift æœ‰å¦‚ä¸‹è¦æ±‚ï¼šåªè¦åœ¨é—­åŒ…å†…ä½¿ç”¨ self çš„æˆå‘˜ï¼Œå°±è¦ç”¨ self.someProperty æˆ–è€… self.someMethod()ï¼ˆè€Œä¸åªæ˜¯ someProperty æˆ– someMethod()ï¼‰ã€‚è¿™æé†’ä½ å¯èƒ½ä¼šä¸€ä¸å°å¿ƒå°±æ•è·äº† selfã€‚
 */
//6.1 å®šä¹‰æ•è·åˆ—è¡¨
/**
 æ•è·åˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹éƒ½ç”±ä¸€å¯¹å…ƒç´ ç»„æˆï¼Œä¸€ä¸ªå…ƒç´ æ˜¯ weak æˆ– unowned å…³é”®å­—ï¼Œå¦ä¸€ä¸ªå…ƒç´ æ˜¯ç±»å®ä¾‹çš„å¼•ç”¨ï¼ˆä¾‹å¦‚ selfï¼‰æˆ–åˆå§‹åŒ–è¿‡çš„å˜é‡ï¼ˆå¦‚ delegate = self.delegate!ï¼‰ã€‚è¿™äº›é¡¹åœ¨æ–¹æ‹¬å·ä¸­ç”¨é€—å·åˆ†å¼€ã€‚
 
 
 1. å¦‚æœé—­åŒ…æœ‰å‚æ•°åˆ—è¡¨å’Œè¿”å›ç±»å‹ï¼ŒæŠŠæ•è·åˆ—è¡¨æ”¾åœ¨å®ƒä»¬å‰é¢ï¼š
 lazy var someClosure: (Int, String) -> String = {
     [unowned self, weak delegate = self.delegate!] (index: Int, stringToProcess: String) -> String in
     // è¿™é‡Œæ˜¯é—­åŒ…çš„å‡½æ•°ä½“
 }
 
 2. å¦‚æœé—­åŒ…æ²¡æœ‰æŒ‡æ˜å‚æ•°åˆ—è¡¨æˆ–è€…è¿”å›ç±»å‹ï¼Œå®ƒä»¬ä¼šé€šè¿‡ä¸Šä¸‹æ–‡æ¨æ–­ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠæ•è·åˆ—è¡¨å’Œå…³é”®å­— in æ”¾åœ¨é—­åŒ…æœ€å¼€å§‹çš„åœ°æ–¹ï¼š
 
 lazy var someClosure: Void -> String = {
     [unowned self, weak delegate = self.delegate!] in
     // è¿™é‡Œæ˜¯é—­åŒ…çš„å‡½æ•°ä½“
 }
 */

//6.2 å¼±å¼•ç”¨å’Œæ— ä¸»å¼•ç”¨
/**
 åœ¨é—­åŒ…å’Œæ•è·çš„å®ä¾‹æ€»æ˜¯äº’ç›¸å¼•ç”¨å¹¶ä¸”æ€»æ˜¯åŒæ—¶é”€æ¯æ—¶ï¼Œå°†é—­åŒ…å†…çš„æ•è·å®šä¹‰ä¸ºæ— ä¸»å¼•ç”¨ã€‚
 åœ¨è¢«æ•è·çš„å¼•ç”¨å¯èƒ½ä¼šå˜ä¸º nil æ—¶ï¼Œå°†é—­åŒ…å†…çš„æ•è·å®šä¹‰ä¸º å¼±å¼•ç”¨ã€‚å¼±å¼•ç”¨æ€»æ˜¯å¯é€‰ç±»å‹ï¼Œå¹¶ä¸”å½“å¼•ç”¨çš„å®ä¾‹è¢«é”€æ¯åï¼Œå¼±å¼•ç”¨çš„å€¼ä¼šè‡ªåŠ¨ç½®ä¸º nilã€‚è¿™ä½¿æˆ‘ä»¬å¯ä»¥åœ¨é—­åŒ…ä½“å†…æ£€æŸ¥å®ƒä»¬æ˜¯å¦å­˜åœ¨ã€‚
 
 æ³¨: å¦‚æœè¢«æ•è·çš„å¼•ç”¨ç»å¯¹ä¸ä¼šå˜ä¸º nilï¼Œåº”è¯¥ç”¨æ— ä¸»å¼•ç”¨ï¼Œè€Œä¸æ˜¯å¼±å¼•ç”¨ã€‚
 */
print("-----------")
let g = {
    class HTMLElement {

        let name: String
        let text: String?

        lazy var asHTML: () -> String = {
            // è¿™é‡Œï¼Œæ•è·åˆ—è¡¨æ˜¯ [unowned self]ï¼Œè¡¨ç¤ºâ€œå°† self æ•è·ä¸ºæ— ä¸»å¼•ç”¨è€Œä¸æ˜¯å¼ºå¼•ç”¨â€
            [unowned self] in
            if let text = self.text {
                return "<\(self.name)>\(text)</\(self.name)>"
            } else {
                return "<\(self.name) />"
            }
        }

        init(name: String, text: String? = nil) {
            self.name = name
            self.text = text
        }

        deinit {
            print("\(name) is being deinitialized")
        }

    }

    var paragraph: HTMLElement? = HTMLElement(name: "p", text: "hello, world")
    print(paragraph!.asHTML())
    paragraph = nil
}

g()
